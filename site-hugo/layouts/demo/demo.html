{{ define "main" }}
<div class="bg-gray-50 min-h-screen">
  {{/* Header */}}
  <div class="bg-gradient-to-br from-gray-900 to-gray-800 text-white py-12">
    <div class="container text-center">
      <h1 class="text-4xl font-bold mb-4">TVS Live Demo</h1>
      <p class="text-xl text-gray-300 max-w-2xl mx-auto">
        Watch votes being encrypted, stored in a Merkle tree, and tallied with threshold decryption.
        No actual server - everything runs in your browser.
      </p>
    </div>
  </div>

  <div class="container py-8">
    {{/* Election Setup */}}
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900 mb-0">Election: Best Programming Language 2025</h2>
        <span id="election-status" class="px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full text-sm font-semibold">Voting Open</span>
      </div>
      <div class="row g-4">
        <div class="col-12 col-md-4">
          <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-3xl font-bold text-gray-900" id="total-voters">0</div>
            <div class="text-gray-600">Registered Voters</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-3xl font-bold text-emerald-600" id="total-votes">0</div>
            <div class="text-gray-600">Votes Cast</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-3xl font-bold text-blue-600" id="merkle-root">-</div>
            <div class="text-gray-600">Merkle Root (first 8 chars)</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      {{/* Left Column - Voting */}}
      <div class="col-12 col-lg-6">
        {{/* Question 1: Single Choice */}}
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div class="d-flex align-items-center gap-2 mb-4">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">Question 1</span>
            <span class="text-gray-500 text-sm">Single Choice</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-4">Best Programming Language 2025?</h3>
          <div class="mb-4">
            <div class="d-flex flex-column gap-2" id="q1-options">
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q1" value="rust" class="form-check-input">
                <span class="font-semibold">Rust</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q1" value="typescript" class="form-check-input">
                <span class="font-semibold">TypeScript</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q1" value="python" class="form-check-input">
                <span class="font-semibold">Python</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q1" value="go" class="form-check-input">
                <span class="font-semibold">Go</span>
              </label>
            </div>
          </div>
        </div>

        {{/* Question 2: Pick up to 2 */}}
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div class="d-flex align-items-center gap-2 mb-4">
            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">Question 2</span>
            <span class="text-gray-500 text-sm">Pick up to 2</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-4">Most important language features?</h3>
          <p class="text-gray-600 text-sm mb-3">Select up to 2 options:</p>
          <div class="mb-4">
            <div class="d-flex flex-column gap-2" id="q2-options">
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="checkbox" name="q2" value="type-safety" class="form-check-input q2-checkbox">
                <span class="font-semibold">Type Safety</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="checkbox" name="q2" value="performance" class="form-check-input q2-checkbox">
                <span class="font-semibold">Performance</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="checkbox" name="q2" value="ecosystem" class="form-check-input q2-checkbox">
                <span class="font-semibold">Ecosystem & Libraries</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="checkbox" name="q2" value="simplicity" class="form-check-input q2-checkbox">
                <span class="font-semibold">Simplicity</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="checkbox" name="q2" value="concurrency" class="form-check-input q2-checkbox">
                <span class="font-semibold">Concurrency Support</span>
              </label>
            </div>
            <div id="q2-limit-msg" class="text-sm text-gray-500 mt-2">0 of 2 selected</div>
          </div>
        </div>

        {{/* Question 3: Single Choice with Write-in */}}
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div class="d-flex align-items-center gap-2 mb-4">
            <span class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded text-xs font-semibold">Question 3</span>
            <span class="text-gray-500 text-sm">Single Choice + Write-in</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-4">Preferred code editor?</h3>
          <div class="mb-4">
            <div class="d-flex flex-column gap-2" id="q3-options">
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q3" value="vscode" class="form-check-input">
                <span class="font-semibold">VS Code</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q3" value="neovim" class="form-check-input">
                <span class="font-semibold">Neovim</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="q3" value="jetbrains" class="form-check-input">
                <span class="font-semibold">JetBrains IDE</span>
              </label>
              <label class="d-flex align-items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 q3-other-label">
                <input type="radio" name="q3" value="other" class="form-check-input" id="q3-other-radio">
                <span class="font-semibold">Other:</span>
                <input type="text" id="q3-other-text" placeholder="Enter your choice..." class="form-control form-control-sm flex-grow-1" style="max-width: 200px;" disabled>
              </label>
            </div>
          </div>
        </div>

        {{/* Submit Button */}}
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <button id="cast-vote-btn" class="btn bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-lg font-semibold w-full text-lg">
            Encrypt & Cast Ballot
          </button>
          <div id="vote-result" class="mt-4 hidden"></div>
        </div>

        {{/* Simulate Voters */}}
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Simulate Multiple Voters</h3>
          <p class="text-gray-600 mb-4">Add simulated voters to see the system in action.</p>
          <div class="d-flex gap-2">
            <button id="add-10-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
              +10 Voters
            </button>
            <button id="add-50-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
              +50 Voters
            </button>
            <button id="add-100-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
              +100 Voters
            </button>
          </div>
        </div>
      </div>

      {{/* Right Column - Results & Votes */}}
      <div class="col-12 col-lg-6">
        {{/* Live Results */}}
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900 mb-0">Live Results</h3>
            <button id="tally-btn" class="btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
              Tally Votes (3-of-5 Trustees)
            </button>
          </div>

          {{/* Q1 Results */}}
          <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">Q1</span>
              <span class="font-semibold text-gray-700">Best Programming Language</span>
            </div>
            <div id="q1-results">
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Rust</span>
                  <span id="q1-rust-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q1-rust-bar" class="progress-bar bg-orange-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>TypeScript</span>
                  <span id="q1-typescript-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q1-typescript-bar" class="progress-bar bg-blue-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Python</span>
                  <span id="q1-python-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q1-python-bar" class="progress-bar bg-yellow-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Go</span>
                  <span id="q1-go-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q1-go-bar" class="progress-bar bg-cyan-500" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          {{/* Q2 Results */}}
          <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">Q2</span>
              <span class="font-semibold text-gray-700">Important Features (pick 2)</span>
            </div>
            <div id="q2-results">
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Type Safety</span>
                  <span id="q2-type-safety-count">0</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q2-type-safety-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Performance</span>
                  <span id="q2-performance-count">0</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q2-performance-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Ecosystem</span>
                  <span id="q2-ecosystem-count">0</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q2-ecosystem-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Simplicity</span>
                  <span id="q2-simplicity-count">0</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q2-simplicity-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Concurrency</span>
                  <span id="q2-concurrency-count">0</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q2-concurrency-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          {{/* Q3 Results */}}
          <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded text-xs font-semibold">Q3</span>
              <span class="font-semibold text-gray-700">Preferred Editor</span>
            </div>
            <div id="q3-results">
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>VS Code</span>
                  <span id="q3-vscode-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q3-vscode-bar" class="progress-bar bg-emerald-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>Neovim</span>
                  <span id="q3-neovim-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q3-neovim-bar" class="progress-bar bg-emerald-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 text-sm">
                  <span>JetBrains</span>
                  <span id="q3-jetbrains-count">0 (0%)</span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div id="q3-jetbrains-bar" class="progress-bar bg-emerald-500" style="width: 0%"></div>
                </div>
              </div>
              <div id="q3-writeins-container">
                {{/* Write-in entries will be added dynamically here */}}
              </div>
            </div>
          </div>

          <div id="tally-status" class="mt-4 text-center text-gray-500 text-sm">
            Results update after tallying
          </div>
        </div>

        {{/* Vote Log */}}
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Vote Log (Encrypted)</h3>
          <p class="text-gray-600 text-sm mb-4">
            This is what the server sees - encrypted votes with no way to read them.
          </p>
          <div id="vote-log" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto" style="max-height: 300px;">
            <div class="text-gray-500">// Waiting for votes...</div>
          </div>
        </div>
      </div>
    </div>

    {{/* How It Works */}}
    <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
      <h3 class="text-xl font-bold text-gray-900 mb-4">How This Demo Works</h3>
      <div class="row g-4">
        <div class="col-12 col-md-3">
          <div class="text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-full d-flex align-items-center justify-content-center mx-auto mb-3">
              <span class="text-blue-600 font-bold">1</span>
            </div>
            <h4 class="font-bold mb-2">VeilForms</h4>
            <p class="text-gray-600 text-sm">Vote encrypted in browser with AES-256-GCM</p>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="text-center">
            <div class="w-12 h-12 bg-emerald-100 rounded-full d-flex align-items-center justify-content-center mx-auto mb-3">
              <span class="text-emerald-600 font-bold">2</span>
            </div>
            <h4 class="font-bold mb-2">VeilChain</h4>
            <p class="text-gray-600 text-sm">Vote added to Merkle tree, root hash updated</p>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="text-center">
            <div class="w-12 h-12 bg-purple-100 rounded-full d-flex align-items-center justify-content-center mx-auto mb-3">
              <span class="text-purple-600 font-bold">3</span>
            </div>
            <h4 class="font-bold mb-2">VeilKey</h4>
            <p class="text-gray-600 text-sm">3-of-5 trustees provide partial decryptions</p>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="text-center">
            <div class="w-12 h-12 bg-pink-100 rounded-full d-flex align-items-center justify-content-center mx-auto mb-3">
              <span class="text-pink-600 font-bold">4</span>
            </div>
            <h4 class="font-bold mb-2">Results</h4>
            <p class="text-gray-600 text-sm">Votes tallied, results published</p>
          </div>
        </div>
      </div>
    </div>

    {{/* Links */}}
    <div class="text-center mt-8">
      <p class="text-gray-600 mb-4">Want to see more?</p>
      <div class="d-flex gap-4 justify-content-center flex-wrap">
        <a href="https://veilforms.com/demo/" target="_blank" rel="noopener" class="btn bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">
          VeilForms Demo
        </a>
        <a href="https://veilchain.io" target="_blank" rel="noopener" class="btn bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold">
          VeilChain Explorer
        </a>
      </div>
    </div>
  </div>
</div>

<script>
// Multi-question demo simulation
(function() {
  const state = {
    voters: 0,
    votes: [],
    results: {
      q1: { rust: 0, typescript: 0, python: 0, go: 0 },
      q2: { 'type-safety': 0, performance: 0, ecosystem: 0, simplicity: 0, concurrency: 0 },
      q3: { vscode: 0, neovim: 0, jetbrains: 0 }
    },
    writeIns: {}, // { "Emacs": 2, "Vim": 1, ... }
    merkleRoot: null,
    tallied: false
  };

  // Simple hash function for demo
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash).toString(16).padStart(8, '0');
  }

  // Generate fake encrypted ballot
  function generateEncryptedBallot(ballot) {
    const iv = Array.from({length: 12}, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join('');
    const ciphertext = Array.from({length: 48}, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join('');
    const tag = Array.from({length: 16}, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join('');
    return { iv, ciphertext, tag, ballot };
  }

  // Update Merkle root
  function updateMerkleRoot() {
    if (state.votes.length === 0) {
      state.merkleRoot = null;
      document.getElementById('merkle-root').textContent = '-';
      return;
    }
    const combined = state.votes.map(v => v.ciphertext).join('');
    state.merkleRoot = simpleHash(combined + Date.now());
    document.getElementById('merkle-root').textContent = state.merkleRoot.substring(0, 8);
  }

  // Add vote to log
  function addToLog(vote, index) {
    const log = document.getElementById('vote-log');
    if (index === 0) {
      log.innerHTML = '';
    }
    const entry = document.createElement('div');
    entry.className = 'mb-2 border-b border-gray-700 pb-2';
    entry.innerHTML = `
      <div class="text-gray-500">// Ballot #${index + 1} (3 questions)</div>
      <div>{</div>
      <div class="pl-4">"iv": "${vote.iv.substring(0, 16)}...",</div>
      <div class="pl-4">"ciphertext": "${vote.ciphertext.substring(0, 32)}...",</div>
      <div class="pl-4">"tag": "${vote.tag.substring(0, 16)}..."</div>
      <div>}</div>
    `;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
  }

  // Update stats
  function updateStats() {
    document.getElementById('total-voters').textContent = state.voters;
    document.getElementById('total-votes').textContent = state.votes.length;
    updateMerkleRoot();
  }

  // Update results display
  function updateResults() {
    const total = state.votes.length || 1;

    // Q1 results
    ['rust', 'typescript', 'python', 'go'].forEach(opt => {
      const count = state.results.q1[opt];
      const pct = Math.round((count / total) * 100);
      document.getElementById(`q1-${opt}-count`).textContent = `${count} (${pct}%)`;
      document.getElementById(`q1-${opt}-bar`).style.width = `${pct}%`;
    });

    // Q2 results (multi-select, so max is 2*total)
    const q2Max = Math.max(...Object.values(state.results.q2), 1);
    ['type-safety', 'performance', 'ecosystem', 'simplicity', 'concurrency'].forEach(opt => {
      const count = state.results.q2[opt];
      const pct = Math.round((count / q2Max) * 100);
      document.getElementById(`q2-${opt}-count`).textContent = count;
      document.getElementById(`q2-${opt}-bar`).style.width = `${pct}%`;
    });

    // Q3 results (fixed options)
    ['vscode', 'neovim', 'jetbrains'].forEach(opt => {
      const count = state.results.q3[opt];
      const pct = Math.round((count / total) * 100);
      document.getElementById(`q3-${opt}-count`).textContent = `${count} (${pct}%)`;
      document.getElementById(`q3-${opt}-bar`).style.width = `${pct}%`;
    });

    // Q3 write-ins (each gets its own bar)
    const writeInsContainer = document.getElementById('q3-writeins-container');
    writeInsContainer.innerHTML = '';

    const writeInEntries = Object.entries(state.writeIns).sort((a, b) => b[1] - a[1]);
    writeInEntries.forEach(([name, count]) => {
      const pct = Math.round((count / total) * 100);
      const div = document.createElement('div');
      div.className = 'mb-2';
      div.innerHTML = `
        <div class="d-flex justify-content-between mb-1 text-sm">
          <span class="d-flex align-items-center gap-1">
            <span class="text-gray-400 text-xs">(write-in)</span>
            ${name}
          </span>
          <span>${count} (${pct}%)</span>
        </div>
        <div class="progress" style="height: 16px;">
          <div class="progress-bar bg-teal-500" style="width: ${pct}%"></div>
        </div>
      `;
      writeInsContainer.appendChild(div);
    });
  }

  // Cast a ballot
  function castBallot(ballot) {
    const vote = generateEncryptedBallot(ballot);
    state.votes.push(vote);
    state.voters++;

    if (state.tallied) {
      // Update results live
      state.results.q1[ballot.q1]++;
      ballot.q2.forEach(opt => state.results.q2[opt]++);
      if (ballot.q3 === 'other' && ballot.q3Text) {
        state.writeIns[ballot.q3Text] = (state.writeIns[ballot.q3Text] || 0) + 1;
      } else {
        state.results.q3[ballot.q3]++;
      }
      updateResults();
    }

    addToLog(vote, state.votes.length - 1);
    updateStats();
    return vote;
  }

  // Add random voters
  function addRandomVoters(count) {
    const q1Options = ['rust', 'typescript', 'python', 'go'];
    const q1Weights = [0.35, 0.30, 0.20, 0.15];
    const q2Options = ['type-safety', 'performance', 'ecosystem', 'simplicity', 'concurrency'];
    const q3Options = ['vscode', 'neovim', 'jetbrains', 'other'];
    const q3Weights = [0.45, 0.20, 0.25, 0.10];
    const otherEditors = ['Emacs', 'Sublime', 'Vim', 'Zed', 'Helix', 'Atom'];

    for (let i = 0; i < count; i++) {
      // Q1: weighted single choice
      let rand = Math.random();
      let cumulative = 0;
      let q1 = q1Options[0];
      for (let j = 0; j < q1Options.length; j++) {
        cumulative += q1Weights[j];
        if (rand < cumulative) { q1 = q1Options[j]; break; }
      }

      // Q2: random 2 from 5
      const shuffled = [...q2Options].sort(() => Math.random() - 0.5);
      const q2 = shuffled.slice(0, 2);

      // Q3: weighted single choice with write-in
      rand = Math.random();
      cumulative = 0;
      let q3 = q3Options[0];
      for (let j = 0; j < q3Options.length; j++) {
        cumulative += q3Weights[j];
        if (rand < cumulative) { q3 = q3Options[j]; break; }
      }
      const q3Text = q3 === 'other' ? otherEditors[Math.floor(Math.random() * otherEditors.length)] : null;

      castBallot({ q1, q2, q3, q3Text });
    }
  }

  // Tally votes
  function tallyVotes() {
    state.tallied = true;
    state.results = {
      q1: { rust: 0, typescript: 0, python: 0, go: 0 },
      q2: { 'type-safety': 0, performance: 0, ecosystem: 0, simplicity: 0, concurrency: 0 },
      q3: { vscode: 0, neovim: 0, jetbrains: 0 }
    };
    state.writeIns = {};

    // "Decrypt" ballots
    state.votes.forEach(vote => {
      const b = vote.ballot;
      state.results.q1[b.q1]++;
      b.q2.forEach(opt => state.results.q2[opt]++);
      if (b.q3 === 'other' && b.q3Text) {
        state.writeIns[b.q3Text] = (state.writeIns[b.q3Text] || 0) + 1;
      } else {
        state.results.q3[b.q3]++;
      }
    });

    updateResults();
    document.getElementById('tally-status').innerHTML = `
      <span class="text-emerald-600 font-semibold">Tallied with 3-of-5 threshold decryption</span>
    `;
  }

  // Q2 checkbox limit (max 2)
  document.querySelectorAll('.q2-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      const checked = document.querySelectorAll('.q2-checkbox:checked');
      const msg = document.getElementById('q2-limit-msg');

      if (checked.length > 2) {
        this.checked = false;
        msg.textContent = '2 of 2 selected (max reached)';
        msg.classList.add('text-red-500');
        msg.classList.remove('text-gray-500');
      } else {
        msg.textContent = `${checked.length} of 2 selected`;
        if (checked.length === 2) {
          msg.classList.add('text-emerald-600');
          msg.classList.remove('text-gray-500', 'text-red-500');
        } else {
          msg.classList.add('text-gray-500');
          msg.classList.remove('text-emerald-600', 'text-red-500');
        }
      }
    });
  });

  // Q3 "Other" text field enable/disable
  document.querySelectorAll('input[name="q3"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const textField = document.getElementById('q3-other-text');
      if (this.value === 'other') {
        textField.disabled = false;
        textField.focus();
      } else {
        textField.disabled = true;
        textField.value = '';
      }
    });
  });

  // Cast ballot button
  document.getElementById('cast-vote-btn').addEventListener('click', function() {
    // Validate Q1
    const q1Selected = document.querySelector('input[name="q1"]:checked');
    if (!q1Selected) {
      alert('Please answer Question 1');
      return;
    }

    // Validate Q2
    const q2Selected = document.querySelectorAll('.q2-checkbox:checked');
    if (q2Selected.length === 0) {
      alert('Please select at least one option for Question 2');
      return;
    }

    // Validate Q3
    const q3Selected = document.querySelector('input[name="q3"]:checked');
    if (!q3Selected) {
      alert('Please answer Question 3');
      return;
    }

    const q3Text = q3Selected.value === 'other' ? document.getElementById('q3-other-text').value.trim() : null;
    if (q3Selected.value === 'other' && !q3Text) {
      alert('Please enter your write-in choice for Question 3');
      return;
    }

    // Build ballot
    const ballot = {
      q1: q1Selected.value,
      q2: Array.from(q2Selected).map(cb => cb.value),
      q3: q3Selected.value,
      q3Text: q3Text
    };

    const vote = castBallot(ballot);
    const resultDiv = document.getElementById('vote-result');
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = `
      <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
        <div class="font-bold text-emerald-800 mb-2">Ballot Encrypted & Cast!</div>
        <div class="text-sm text-gray-600">
          <div>3 questions encrypted together</div>
          <div>Ciphertext: <code class="bg-gray-100 px-1">${vote.ciphertext.substring(0, 16)}...</code></div>
          <div>Merkle Position: <code class="bg-gray-100 px-1">#${state.votes.length}</code></div>
        </div>
      </div>
    `;

    // Clear selections
    q1Selected.checked = false;
    q2Selected.forEach(cb => cb.checked = false);
    q3Selected.checked = false;
    document.getElementById('q3-other-text').disabled = true;
    document.getElementById('q3-other-text').value = '';
    document.getElementById('q2-limit-msg').textContent = '0 of 2 selected';
    document.getElementById('q2-limit-msg').classList.remove('text-emerald-600');
    document.getElementById('q2-limit-msg').classList.add('text-gray-500');
  });

  document.getElementById('add-10-btn').addEventListener('click', () => addRandomVoters(10));
  document.getElementById('add-50-btn').addEventListener('click', () => addRandomVoters(50));
  document.getElementById('add-100-btn').addEventListener('click', () => addRandomVoters(100));
  document.getElementById('tally-btn').addEventListener('click', tallyVotes);

  // Initialize
  updateStats();
})();
</script>
{{ end }}
